<!DOCTYPE html><html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Data Penjualan</title>
    <link href="style.css" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body class="bg-light">
  <div class="container my-5">
    <div class="card shadow-lg rounded-4">
      <div class="card-body">
        <h3 class="text-center mb-4">Data Penjualan</h3><!-- Filter -->
    <form id="filterForm" class="row g-3 mb-4">
      <div class="col-md-3">
        <label class="form-label">Perusahaan</label>
        <input type="text" id="filterCompany" class="form-control" placeholder="Nama Perusahaan">
      </div>
      <div class="col-md-3">
        <label class="form-label">Dari</label>
        <input type="datetime-local" id="filterStart" class="form-control">
      </div>
      <div class="col-md-3">
        <label class="form-label">Sampai</label>
        <input type="datetime-local" id="filterEnd" class="form-control">
      </div>
      <div class="col-md-3">
        <label class="form-label">Bulan</label>
        <input type="month" id="filterMonth" class="form-control">
      </div>
      <div class="col-12 text-end">
        <button type="submit" class="btn btn-primary">Terapkan Filter</button>
        <button type="button" id="resetFilter" class="btn btn-secondary">Reset</button>
        <button type="button" id="exportBtn" class="btn btn-success">Export Excel</button>
      </div>
    </form>

    <div class="table-responsive">
      <table class="table table-bordered table-striped" id="salesTable">
        <thead class="table-dark">
          <tr>
            <th>No</th>
            <th>Tanggal</th>
            <th>Perusahaan</th>
            <th>No. Truck</th>
            <th>Loading Time</th>
            <th>Release Time</th>
            <th>Tare Weight</th>
            <th>Gross Weight</th>
            <th>Net Weight</th>
            <th>Aksi</th>
          </tr>
        </thead>
        <tbody id="dataBody"></tbody>
        <tfoot>
          <tr>
            <td colspan="8" class="text-end fw-bold">Total Net Weight (ton):</td>
            <td id="totalNetWeight" class="fw-bold" colspan="2"></td>
          </tr>
        </tfoot>
      </table>
    </div>

    <div class="text-center mt-4">
      <a href="index.html">Kembali ke Form Input</a>
    </div>
  </div>
</div>

  </div>  <!-- Firebase & Script -->  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
    import { getDatabase, ref, onValue, update, remove } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD21AniBt0GcuShvdrmeJR3lmdOlYhUEiU",
      authDomain: "workrequest-8482a.firebaseapp.com",
      databaseURL: "https://workrequest-8482a-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "workrequest-8482a",
      storageBucket: "workrequest-8482a.appspot.com",
      messagingSenderId: "230020602695",
      appId: "1:230020602695:web:802e9f107a8987e532ca62"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const dbRef = ref(db, 'penjualan/');

    const dataBody = document.getElementById("dataBody");
    const totalCell = document.getElementById("totalNetWeight");
    const form = document.getElementById("filterForm");
    const resetBtn = document.getElementById("resetFilter");
    const exportBtn = document.getElementById("exportBtn");

    let allData = [];
    let allKeys = [];
    let currentFilteredData = [];
    let todayData = [];

    function renderTable(dataList) {
      dataBody.innerHTML = "";
      let totalNetWeight = 0;

      currentFilteredData = dataList;

      dataList.forEach((data, index) => {
        const key = allKeys[index];
        const tare = parseFloat(data.tareWeight).toFixed(2);
        const gross = parseFloat(data.grossWeight).toFixed(2);
        const net = (parseFloat(data.grossWeight) - parseFloat(data.tareWeight)).toFixed(2);
        totalNetWeight += parseFloat(net);

        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${index + 1}</td>
          <td>${data.date}</td>
          <td>${data.company}</td>
          <td>${data.truckNumber}</td>
          <td>${data.loadingTime}</td>
          <td>${data.releaseTime}</td>
          <td><input type="number" step="0.01" class="form-control" value="${tare}" id="tare-${key}" disabled></td>
          <td><input type="number" step="0.01" class="form-control" value="${gross}" id="gross-${key}" disabled></td>
          <td id="net-${key}">${net}</td>
          <td>
            <button class="btn btn-sm btn-warning me-1" onclick="enableEdit('${key}')">Edit</button>
            <button class="btn btn-sm btn-success me-1" onclick="updateData('${key}')">Update</button>
            <button class="btn btn-sm btn-danger" onclick="deleteData('${key}')">Hapus</button>
          </td>
        `;
        dataBody.appendChild(row);
      });

      totalCell.textContent = totalNetWeight.toFixed(2);
    }

    let editingStates = {};

function enableEdit(key) {
  const tareInput = document.getElementById(`tare-${key}`);
  const grossInput = document.getElementById(`gross-${key}`);
  const editButton = document.querySelector(`button[onclick="enableEdit('${key}')"]`);

  if (editingStates[key]) {
    // Batalkan edit
    tareInput.disabled = true;
    grossInput.disabled = true;
    editButton.textContent = 'Edit';
    editingStates[key] = false;
  } else {
    // Aktifkan edit
    tareInput.disabled = false;
    grossInput.disabled = false;
    editButton.textContent = 'Batal';
    editingStates[key] = true;
  }
}
    window.enableEdit = enableEdit;

    function updateData(key) {
      const newTare = parseFloat(document.getElementById(`tare-${key}`).value);
      const newGross = parseFloat(document.getElementById(`gross-${key}`).value);

      if (isNaN(newTare) || isNaN(newGross)) {
        alert("Nilai tare atau gross tidak valid.");
        return;
      }

      const updates = {
        tareWeight: newTare,
        grossWeight: newGross
      };

      const itemRef = ref(db, `penjualan/${key}`);
      update(itemRef, updates)
        .then(() => alert("Data berhasil diperbarui."))
        .catch((err) => alert("Gagal memperbarui data: " + err));
    }
    window.updateData = updateData;

    function deleteData(key) {
      if (confirm("Yakin ingin menghapus data ini?")) {
        const itemRef = ref(db, `penjualan/${key}`);
        remove(itemRef)
          .then(() => alert("Data berhasil dihapus."))
          .catch((err) => alert("Gagal menghapus data: " + err));
      }
    }
    window.deleteData = deleteData;

    function applyFilter() {
      const company = document.getElementById("filterCompany").value.toLowerCase();
      const start = new Date(document.getElementById("filterStart").value);
      const end = new Date(document.getElementById("filterEnd").value);
      const monthValue = document.getElementById("filterMonth").value;

      const filtered = allData.filter((d, i) => {
        const matchCompany = !company || d.company.toLowerCase().includes(company);
        const dateTime = new Date(`${d.date}T${d.loadingTime}`);
        const matchStart = isNaN(start.getTime()) || dateTime >= start;
        const matchEnd = isNaN(end.getTime()) || dateTime <= end;
        const matchMonth = !monthValue || (
          dateTime.getFullYear() === parseInt(monthValue.split("-")[0]) &&
          (dateTime.getMonth() + 1) === parseInt(monthValue.split("-")[1])
        );
        return matchCompany && matchStart && matchEnd && matchMonth;
      });

      renderTable(filtered);
    }
function isToday(dateStr, timeStr) {
  const now = new Date();
  const dataDate = new Date(`${dateStr}T${timeStr}`);
  return dataDate.toDateString() === now.toDateString();
}

function sortByDateTime(dataArray) {
  return dataArray.sort((a, b) => {
    const dateA = new Date(`${a.date}T${a.loadingTime}`);
    const dateB = new Date(`${b.date}T${b.loadingTime}`);
    return dateA - dateB; // Urut dari paling awal ke paling akhir
  });
}
    onValue(dbRef, (snapshot) => {
  const data = snapshot.val();
  const rawData = data ? Object.entries(data) : [];

  allKeys = rawData.map(([key]) => key);
  allData = rawData.map(([_, val]) => val);

  // Ambil data hari ini untuk tampilan awal
  todayData = rawData
    .filter(([_, val]) => isToday(val.date, val.loadingTime))
    .sort((a, b) => {
      const dateA = new Date(`${a[1].date}T${a[1].loadingTime}`);
      const dateB = new Date(`${b[1].date}T${b[1].loadingTime}`);
      return dateA - dateB;
    });

  const todayKeys = todayData.map(([key]) => key);
  const todayValues = todayData.map(([_, val]) => val);

  allKeys = todayKeys;
  renderTable(todayValues);  // tampilkan hanya data hari ini
});

    form.addEventListener("submit", (e) => {
      e.preventDefault();
      applyFilter();
    });

    resetBtn.addEventListener("click", () => {
      form.reset();
      renderTable(allData);
    });

    exportBtn.addEventListener("click", () => {
      const exportData = currentFilteredData.map((data, i) => {
        const tare = parseFloat(data.tareWeight);
        const gross = parseFloat(data.grossWeight);
        const net = (gross - tare).toFixed(2);
        return {
          No: i + 1,
          Tanggal: data.date,
          Perusahaan: data.company,
          "No. Truck": data.truckNumber,
          "Loading Time": data.loadingTime,
          "Release Time": data.releaseTime,
          "Tare Weight": tare.toFixed(2),
          "Gross Weight": gross.toFixed(2),
          "Net Weight": net
        };
      });
      const worksheet = XLSX.utils.json_to_sheet(exportData);
      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, "Data Penjualan");
      XLSX.writeFile(workbook, "data-penjualan.xlsx");
    });
  </script></body>
</html>